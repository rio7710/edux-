generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ──────────────────────────────────────
// 인증/인가
// ──────────────────────────────────────

enum Role {
  admin
  operator
  editor
  instructor
  viewer
  guest
}

enum GroupMemberRole {
  owner
  manager
  member
}

enum PermissionEffect {
  allow
  deny
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  name              String
  phone             String?
  website           String?
  avatarUrl         String?
  role              Role               @default(guest)
  hashedPassword    String? // nullable for social login users
  provider          String? // 'local' | 'google' | 'kakao' etc.
  providerId        String? // social provider's user id
  isActive          Boolean            @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime? // soft delete
  instructorProfile InstructorProfile?
  instructor        Instructor?        @relation("UserInstructor")
  CourseSharesReceived CourseShare[]   @relation("CourseShareSharedWith")
  CourseSharesSent   CourseShare[]     @relation("CourseShareSharedBy")
  RenderJobs        RenderJob[]
  UserDocuments     UserDocument[]
  GroupMembers      GroupMember[]
  PermissionGrants  PermissionGrant[]
  LectureGrants     LectureGrant[]
  MessagesReceived  UserMessage[]      @relation("UserMessageRecipient")
  MessagesSent      UserMessage[]      @relation("UserMessageSender")
}

model Group {
  id               String            @id @default(cuid())
  name             String
  description      String?
  createdBy        String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?
  Members          GroupMember[]
  PermissionGrants PermissionGrant[]

  @@index([name])
  @@index([deletedAt])
}

model GroupMember {
  id         String          @id @default(cuid())
  groupId    String
  userId     String
  memberRole GroupMemberRole @default(member)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  deletedAt  DateTime?
  Group      Group           @relation(fields: [groupId], references: [id], onDelete: Cascade)
  User       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId, deletedAt])
  @@index([userId, deletedAt])
}

model PermissionGrant {
  id            String           @id @default(cuid())
  permissionKey String
  effect        PermissionEffect
  userId        String?
  groupId       String?
  role          Role?
  createdBy     String?
  note          String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  deletedAt     DateTime?
  User          User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  Group         Group?           @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([permissionKey, deletedAt])
  @@index([userId, permissionKey, deletedAt])
  @@index([groupId, permissionKey, deletedAt])
  @@index([role, permissionKey, deletedAt])
}

// ──────────────────────────────────────
// 강사
// ──────────────────────────────────────

model Instructor {
  id             String           @id @default(cuid())
  userId         String?          @unique
  name           String
  title          String?
  email          String?
  affiliation    String?
  avatarUrl      String?
  tagline        String?
  bio            String?
  specialties    String[]
  certifications Json?            // [{name, issuer, date, fileUrl}]
  awards         String[]
  links          Json?
  degrees        Json?            // [{name, school, major, year, fileUrl}]
  careers        Json?            // [{company, role, period, description}]
  publications   Json?            // [{title, type, year, publisher, url}]
  createdBy      String? // 등록자 ID
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  deletedAt      DateTime?
  Schedules      CourseSchedule[]
  CourseInstructors CourseInstructor[]
  User           User?            @relation("UserInstructor", fields: [userId], references: [id], onDelete: SetNull)
}

// 임시 강사 신청/프로파일 저장용 모델
model InstructorProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  displayName String?
  title       String?
  bio         String?
  links          Json?
  degrees        Json?
  careers        Json?
  publications   Json?
  certifications Json?
  specialties    String[]
  affiliation    String?
  email          String?
  isApproved     Boolean  @default(false)
  isPending      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  User User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ──────────────────────────────────────
// 코스
// ──────────────────────────────────────

model Course {
  id            String           @id @default(cuid())
  title         String
  description   String?
  durationHours Int?
  isOnline      Boolean?
  equipment     String[]
  goal          String?
  content       String?
  notes         String?
  createdBy     String? // 등록자 ID
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  deletedAt     DateTime?
  Schedules     CourseSchedule[]
  CourseInstructors CourseInstructor[]
  CourseShares  CourseShare[]
  CourseLectures CourseLecture[]
}

enum CourseShareStatus {
  pending
  accepted
  rejected
}

enum LectureGrantSourceType {
  manual
  course_share
}

enum UserMessageCategory {
  system
  course_share
  lecture_grant
  instructor_approval
}

model CourseShare {
  id               String            @id @default(cuid())
  courseId         String
  sharedWithUserId String
  sharedByUserId   String
  status           CourseShareStatus @default(pending)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  respondedAt      DateTime?

  Course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  SharedWith User   @relation("CourseShareSharedWith", fields: [sharedWithUserId], references: [id], onDelete: Cascade)
  SharedBy   User   @relation("CourseShareSharedBy", fields: [sharedByUserId], references: [id], onDelete: Cascade)

  @@unique([courseId, sharedWithUserId])
  @@index([sharedWithUserId, status])
  @@index([sharedByUserId])
}

model CourseInstructor {
  id           String     @id @default(cuid())
  courseId     String
  instructorId String
  createdAt    DateTime   @default(now())

  Course      Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Instructor  Instructor @relation(fields: [instructorId], references: [id], onDelete: Cascade)

  @@unique([courseId, instructorId])
  @@index([instructorId])
}

model CourseLecture {
  id         String   @id @default(cuid())
  courseId   String
  lectureId  String
  order      Int      @default(0)
  createdBy  String?
  createdAt  DateTime @default(now())

  Course   Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Lecture  Lecture @relation(fields: [lectureId], references: [id], onDelete: Cascade)

  @@unique([courseId, lectureId])
  @@index([courseId])
  @@index([lectureId])
}

model Lecture {
  id          String    @id @default(cuid())
  title       String
  description String?
  hours       Float?
  order       Int       @default(0)
  createdBy   String?
  authorId    String? // 원저작자
  originLectureId String? // 복제본 원본 참조
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  CourseLinks CourseLecture[]
  Grants      LectureGrant[]
}

model LectureGrant {
  id              String   @id @default(cuid())
  lectureId       String
  userId          String
  grantedByUserId String
  sourceType      LectureGrantSourceType @default(manual)
  sourceRefId     String?
  canMap          Boolean  @default(false)
  canEdit         Boolean  @default(false)
  canReshare      Boolean  @default(false)
  createdAt       DateTime @default(now())
  revokedAt       DateTime?

  Lecture Lecture @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  User    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([lectureId, userId])
  @@index([userId])
  @@index([sourceType, sourceRefId])
}

model UserMessage {
  id              String              @id @default(cuid())
  recipientUserId String
  senderUserId    String?
  category        UserMessageCategory @default(system)
  title           String
  body            String?
  actionType      String?
  actionPayload   Json?
  isRead          Boolean             @default(false)
  readAt          DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  deletedAt       DateTime?

  Recipient User  @relation("UserMessageRecipient", fields: [recipientUserId], references: [id], onDelete: Cascade)
  Sender    User? @relation("UserMessageSender", fields: [senderUserId], references: [id], onDelete: SetNull)

  @@index([recipientUserId, createdAt(sort: Desc)])
  @@index([recipientUserId, isRead, createdAt(sort: Desc)])
  @@index([recipientUserId, category, createdAt(sort: Desc)])
  @@index([senderUserId, createdAt(sort: Desc)])
}

model CourseSchedule {
  id           String      @id @default(cuid())
  courseId     String
  instructorId String?
  date         DateTime?
  location     String?
  audience     String?
  remarks      String?
  customFields Json?
  createdBy    String? // 등록자 ID
  createdAt    DateTime    @default(now())
  deletedAt    DateTime?
  Course       Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Instructor   Instructor? @relation(fields: [instructorId], references: [id])
}

// ──────────────────────────────────────
// 템플릿
// ──────────────────────────────────────

model Template {
  id        String            @id @default(cuid())
  name      String
  type      String            @default("course_intro")
  css       String
  html      String
  createdBy String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  deletedAt DateTime?
  Versions  TemplateVersion[]
  RenderJobs RenderJob[]
  UserDocuments UserDocument[]

  @@index([deletedAt])
}

model TemplateVersion {
  id         String   @id @default(cuid())
  templateId String
  version    Int
  css        String
  html       String
  changelog  String?
  createdAt  DateTime @default(now())
  Template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
}

// ──────────────────────────────────────
// 렌더 작업
// ──────────────────────────────────────

enum JobStatus {
  pending
  processing
  done
  failed
}

model RenderJob {
  id           String    @id @default(cuid())
  userId       String
  templateId   String
  targetType   String // 'course' | 'schedule' | 'instructor_profile'
  targetId     String
  status       JobStatus @default(pending)
  pdfUrl       String?
  errorMessage String?
  createdAt    DateTime  @default(now())

  User     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Template Template @relation(fields: [templateId], references: [id])
  UserDocuments UserDocument[]

  @@index([userId])
  @@index([targetType, targetId])
}

// ──────────────────────────────────────
// 사이트 설정 (테이블 컬럼)
// ──────────────────────────────────────

model TableColumnConfig {
  id          String   @id @default(cuid())
  tableKey    String
  columnKey   String
  label       String
  customLabel String?
  visible     Boolean  @default(true)
  order       Int
  width       Int?
  fixed       String?
  ownerType   String   @default("global")
  ownerId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tableKey, columnKey, ownerType, ownerId])
  @@index([tableKey, ownerType, ownerId])
}

// ──────────────────────────────────────
// 사이트 설정 (공통)
// ──────────────────────────────────────

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ──────────────────────────────────────
// 사용자 문서 (렌더 결과물 관리)
// ──────────────────────────────────────

model UserDocument {
  id          String   @id @default(cuid())
  userId      String
  renderJobId String
  templateId  String
  targetType  String
  targetId    String
  label       String?
  pdfUrl      String
  shareToken  String?  @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  RenderJob RenderJob @relation(fields: [renderJobId], references: [id])
  Template  Template  @relation(fields: [templateId], references: [id])

  @@index([userId])
  @@index([shareToken])
  @@index([targetType, targetId])
}
