# 필독 문서 (2026-02-13)

이 문서는 **다른 작업자가 바로 이어서 작업**할 수 있도록 오늘 기준 상태와 필수 주의사항을 정리한 문서입니다.

## 1) 현재 시스템 상태

- 백엔드: `http://localhost:7777` 실행 중
- 프론트: `http://localhost:5173` 실행 중
- 헬스체크: `GET /health` 정상 응답 (`{"status":"ok"}`)
- DB 마이그레이션: 최신 상태 확인됨 (`prisma migrate status`)

## 2) 오늘 반영된 핵심 변경

- 코스 공유/수락/해제 동기화 강화
  - `course.shareInvite/respond/revoke/leave/delete`에서 `CourseShare`와 `LectureGrant` 동기화 로직 강화
  - 공유 해제 시 다른 `accepted` 공유가 있으면 즉시 회수 대신 fallback 재연결(reassign) 처리
- 강의 권한 출처 분리
  - `LectureGrant`에 `sourceType`, `sourceRefId` 추가
  - `manual`(수동) / `course_share`(공유자동) 구분
  - 마이그레이션: `prisma/migrations/20260213153000_add_lecture_grant_source/`
- 로그인 장애 복구
  - 원인: Prisma Client가 `--no-engine` 모드로 생성되어 `prisma://` 요구
  - 조치: 로컬은 일반 모드로 `npx prisma generate` 재생성
- MCP 메시지함 백엔드/프론트 연동
  - `UserMessage` 모델/enum 추가 및 마이그레이션 반영
    - `prisma/migrations/20260213190000_add_user_message/`
  - 신규 MCP 툴 추가
    - `message.list`, `message.unreadCount`, `message.markRead`, `message.markAllRead`, `message.send`, `message.seedDummy`
  - 이벤트 연동 추가
    - `course.shareInvite/respond/revoke/leave`
    - `lecture.grant.upsert/delete/leave`
    - `user.approveInstructor`
  - 프론트 `메시지함` 화면에서 더미 6개 생성/읽음 처리/공유 액션 바로 실행 가능

## 3) 작업 전 필수 체크리스트

1. 서버 상태 확인
   - `http://localhost:7777/health`
   - `http://localhost:5173`
2. Prisma 상태 확인
   - `npx prisma migrate status`
   - `npx prisma generate`
3. 타입/빌드 확인
   - `npx tsc --noEmit`
   - `npm --prefix ui run build`
4. 테스트 확인
   - `npm test -- --run`

## 4) 자주 나는 장애와 즉시 복구

- 증상: 로그인 시 `the URL must start with the protocol prisma://`
  - 복구: `npx prisma generate` 후 백엔드 재시작
- 증상: `MCP request failed (500)` 또는 `/sse` 실패
  - 점검:
    - `http://localhost:7777/health` 확인
    - 7777 포트 중복 실행 여부 확인
    - 백엔드 재시작
- 증상: `EADDRINUSE :7777`
  - 점검/조치:
    - `netstat -ano | findstr :7777`
    - 중복 프로세스 종료 후 재기동

## 5) 작업 규칙 (중요)

- 로컬에서 `prisma generate --no-engine` 사용 금지
- 공유/권한 로직 수정 시 `sourceType/sourceRefId` 정책 깨지지 않게 유지
- 현재 워크트리는 변경 파일이 많음
  - 본인이 건드리지 않은 파일 되돌리지 말 것
  - 커밋 전 변경 범위 명확히 분리할 것

## 6) 참고 문서

- `document/COURSE_GUIDE.md` (코스 정책/공유 규칙/장애 대응 업데이트 포함)
- `document/07_TESTING/DEPLOY_TEST_2026-02-13/00_INDEX.md` (배포 테스트 패키지 인덱스)
- `document/07_TESTING/DEPLOY_TEST_2026-02-13/` (필수/확장 + 프론트/백엔드/DB/MCP 품질 게이트)
- `document/10_HANDOFF/03_to_codex.md`
- `document/10_HANDOFF/04_to_claude.md`

## 7) 로그 위치

- 백엔드/프론트 재기동 로그:
  - `logs/reboot-backend.out.log`
  - `logs/reboot-backend.err.log`
  - `logs/reboot-ui.out.log`
  - `logs/reboot-ui.err.log`
